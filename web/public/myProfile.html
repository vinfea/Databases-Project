<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile</title>
</head>
<body>
    <h1>Profile</h1>
    <div id="usernameDisplay"></div> <!-- Added display for username -->
    <div id="roleDisplay"></div> <!-- Added display for role -->
    <form id="profileForm">
        <!-- Common fields for both customers and employees -->
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required><br>

        <label for="address">Address:</label>
        <input type="text" id="address" name="address" required><br>

        <!-- Unique fields for employees -->
        <div id="employeeFields" style="display: none;">
            <label for="hotelId">Hotel ID:</label>
            <input type="text" id="hotelId" name="hotelId"><br>

            <label for="chain">Chain:</label>
            <input type="text" id="chain" name="chain"><br>
        </div>

        <!-- Submit button -->
        <button type="submit" id="updateProfileBtn">Update Profile</button>
        <p id="updateMessage"></p> <!-- Added message display -->
    </form>

    <script>
        // Retrieve data from localStorage
        let username = localStorage.getItem('username');
        let role = localStorage.getItem('role');

        // Display username and role
        document.getElementById('usernameDisplay').textContent = 'Username: ' + username;
        document.getElementById('roleDisplay').textContent = 'Role: ' + role;

        document.addEventListener('DOMContentLoaded', async () => {
            const profileForm = document.getElementById('profileForm');
            const employeeFields = document.getElementById('employeeFields');
            const updateProfileBtn = document.getElementById('updateProfileBtn');
            const updateMessage = document.getElementById('updateMessage');

            // Fetch user profile data from the backend
            try {
                const response = await fetch(`/api/profile?userType=${role}&username=${username}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch profile data');
                }
                const userData = await response.text(); // Changed from .json() to .text()

                // Update the profile section with the HTML received from the backend
                document.body.innerHTML += userData; // Append HTML to the body

                if (role === 'employee') {
                    // If user is an employee, display employee-specific fields
                    employeeFields.style.display = 'block';
                }

                // Populate name and address fields from the received data
                const nameInput = document.getElementById('name');
                const addressInput = document.getElementById('address');
                const nameMatch = userData.match(/<p><strong>name<\/strong>: (.*?)<\/p>/);
                const addressMatch = userData.match(/<p><strong>address<\/strong>: (.*?)<\/p>/);
                if (nameMatch && addressMatch) {
                    nameInput.value = nameMatch[1];
                    addressInput.value = addressMatch[1];
                }
            } catch (error) {
                console.error('Error fetching profile data:', error);
                alert('Failed to fetch profile data. Please try again later.');
            }

            // Handle form submission
            profileForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const formData = new FormData(profileForm);
                console.log('Form data:', formData); // Log form data

                try {
                    const response = await fetch('/api/updateProfile', {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        throw new Error('Failed to update profile');
                    }
                    const data = await response.json(); // Parse response data
                    updateMessage.textContent = data.message; // Display success message
                    updateMessage.style.color = 'green'; // Set success message color
                    // Optionally, reset form fields or perform other actions after successful update
                } catch (error) {
                    console.error('Error updating profile:', error);
                    updateMessage.textContent = 'Failed to update profile. Please try again later.'; // Display error message
                    updateMessage.style.color = 'red'; // Set error message color
                }
            });
        });
    </script>
</body>
</html>
